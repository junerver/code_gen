# 目录结构详解

<cite>
**本文档引用的文件**   
- [app.vue](file://app\app.vue)
- [chat.post.ts](file://server\api\chat.post.ts)
- [template-gen.ts](file://shared\prompt\template-gen.ts)
- [conversation.ts](file://app\stores\conversation.ts)
- [conversation.ts](file://app\types\conversation.ts)
- [chat.ts](file://app\types\chat.ts)
- [useChat.ts](file://app\composables\useChat.ts)
- [store.ts](file://app\composables\store.ts)
- [conv-repos.ts](file://app\types\conv-repos.ts) - *新增于提交 cfab565a*
- [pinia-conv-repos.ts](file://app\utils\pinia-conv-repos.ts) - *新增于提交 cfab565a*
</cite>

## 更新摘要
**变更内容**   
- 新增了 `IConversationRepository` 接口和 `PiniaConversationRepository` 适配器类，实现 `useChat` 与会话管理的解耦
- 更新了 `useChat` 组合式函数以支持依赖注入模式
- 新增了架构依赖关系图以展示解耦后的模块交互
- 所有文件引用均已更新以反映最新的代码状态

## 目录结构

本项目采用分层与功能模块相结合的组织方式，整体结构清晰，职责分明。前端、后端与共享代码分离，便于维护和扩展。

``mermaid
graph TB
subgraph "前端 (app/)"
A[components] --> |UI组件| F[pages]
B[composables] --> |逻辑复用| F
C[stores] --> |状态管理| B
D[types] --> |类型定义| B & C & F
E[utils] --> |工具函数| B & F
F[pages] --> |页面路由| G[app.vue]
G --> |根组件| H[NuxtPage]
end
subgraph "后端 (server/)"
I[api/chat.post.ts] --> |处理请求| J[utils/model]
K[core/steps/design-component] --> |核心处理逻辑| I
end
subgraph "共享层 (shared/)"
L[prompt/template-gen.ts] --> |提供提示词| I
M[utils/code.ts] --> |通用工具| A & E & K
end
I --> L
B --> C
D --> C
```

**图示来源**
- [app.vue](file://app\app.vue#L1-L7)
- [server/api/chat.post.ts](file://server\api\chat.post.ts#L1-L26)
- [shared/prompt/template-gen.ts](file://shared\prompt\template-gen.ts#L1-L66)
- [app/stores/conversation.ts](file://app\stores\conversation.ts#L1-L318)

**本节来源**
- [app/app.vue](file://app\app.vue#L1-L7)
- [server/api/chat.post.ts](file://server\api\chat.post.ts#L1-L26)
- [shared/prompt/template-gen.ts](file://shared\prompt\template-gen.ts#L1-L66)

## 核心模块解析

### 前端模块（app/）

#### 组件（components）
存放可复用的UI组件，如 `CodePreview.vue`，用于展示生成的代码片段。

#### 可组合函数（composables）
封装可复用的业务逻辑：
- `useChat.ts`：处理聊天相关的交互逻辑
- `store.ts`：集成Pinia状态管理

#### 页面（pages）
基于Nuxt的文件路由系统：
- `pages/index.vue`：首页
- `pages/chat/index.vue`：聊天主界面

#### 状态管理（stores）
使用Pinia进行状态管理，核心文件为 `conversation.ts`，管理会话列表、活跃会话、消息记录等。

#### 类型定义（types）
集中定义应用数据结构：
- `chat.ts`：定义 `ChatMessage` 消息类型
- `conversation.ts`：定义 `Conversation` 会话类型
- `conv-repos.ts`：定义 `IConversationRepository` 会话存储仓库接口

#### 工具函数（utils）
前端专用工具，如 `encode.ts`（编码处理）、`dependency.ts`（依赖分析）、`pinia-conv-repos.ts`（Pinia存储适配器）

#### 模板文件（template）
存放代码生成所需的前端模板，如 `main.vue`、`welcome.vue` 等。

**本节来源**
- [app/types/chat.ts](file://app\types\chat.ts#L1-L21)
- [app/types/conversation.ts](file://app\types\conversation.ts#L1-L79)
- [app/stores/conversation.ts](file://app\stores\conversation.ts#L1-L318)
- [app/composables/useChat.ts](file://app\composables\useChat.ts)
- [app/composables/store.ts](file://app\composables\store.ts)
- [app/types/conv-repos.ts](file://app\types\conv-repos.ts#L1-L129) - *新增于提交 cfab565a*
- [app/utils/pinia-conv-repos.ts](file://app\utils\pinia-conv-repos.ts#L1-L114) - *新增于提交 cfab565a*

### 后端模块（server/）

#### API 接口（api）
- `chat.post.ts`：核心API入口，处理POST请求，调用AI模型流式响应

#### 工具函数（utils）
- `model.ts`：定义AI模型配置（如 `siliconflow`）
- `format.ts`：数据格式化工具

#### 核心处理逻辑（core/steps/design-component）
包含代码生成的核心步骤实现，目前仅有一个设计组件步骤。

**本节来源**
- [server/api/chat.post.ts](file://server\api\chat.post.ts#L1-L26)
- [server/utils/model.ts](file://server\utils\model.ts)

### 共享模块（shared/）

#### 提示词模板（prompt）
- `template-gen.ts`：定义AI生成代码时使用的系统提示词
- `ai-gen.ts`：可能包含其他AI生成逻辑

#### 通用工具（utils）
- `code.ts`：代码相关工具
- `id.ts`：ID生成工具
- `string.ts`：字符串处理工具

这些文件可在前后端共用，提升代码复用性。

**本节来源**
- [shared/prompt/template-gen.ts](file://shared\prompt\template-gen.ts#L1-L66)
- [shared/utils/code.ts](file://shared\utils\code.ts)
- [shared/utils/id.ts](file://shared\utils\id.ts)
- [shared/utils/string.ts](file://shared\utils\string.ts)

## 核心文件深度分析

### app.vue：应用根组件

作为Nuxt应用的入口组件，`app.vue` 结构极简，仅包含路由公告器和页面容器。

```vue
<template>
  <div>
    <NuxtRouteAnnouncer />
    <NuxtPage />
  </div>
</template>
```

其职责是渲染当前路由对应的页面内容，所有页面通过 `<NuxtPage />` 动态加载。

**本节来源**
- [app.vue](file://app\app.vue#L1-L7)

### chat.post.ts：后端API入口

该文件是 `/api/chat` POST 请求的处理器，负责接收用户消息并返回AI流式响应。

```ts
export default defineLazyEventHandler(async () => {
  return defineEventHandler(async (event: any) => {
    const { messages } = await readBody(event);
    const result = streamText({
      model: siliconflow('Qwen/Qwen3-Coder-30B-A3B-Instruct'),
      system: templateGenPrompt(),
      messages,
    });
    return result.toUIMessageStreamResponse();
  });
});
```

关键点：
- 使用 `streamText` 实现流式输出
- 系统提示词来自共享模块 `template-gen.ts`
- 返回格式兼容前端UI组件

**本节来源**
- [server/api/chat.post.ts](file://server\api\chat.post.ts#L1-L26)

### conversation.ts（stores）：会话状态模型

使用Pinia定义会话状态，核心功能包括：
- 会话增删改查
- 消息管理
- 活跃会话切换
- 状态重置

提供了完整的响应式状态管理接口，如 `activeConversation` 计算属性、`addMessage` 方法等。

```ts
export const useConversationStore = defineStore('conversation', () => {
  const conversations = ref<Conversation[]>([]);
  const activeConversationId = ref<string>('');
  // ... 其他状态与方法
});
```

**本节来源**
- [app/stores/conversation.ts](file://app\stores\conversation.ts#L1-L318)

### conversation.ts（types）：会话数据结构

定义了会话的核心数据结构：

```ts
export interface Conversation {
  id: string;
  title: string;
  group?: string;
  lastMessage?: string;
  createdAt: Date;
  updatedAt: Date;
  config?: ConversationConfig;
}
```

以及配套的创建、更新参数接口，确保类型安全。

**本节来源**
- [app/types/conversation.ts](file://app\types\conversation.ts#L1-L79)

### template-gen.ts：提示词模板生成器

提供AI生成代码所需的系统提示词，内容结构化，包含：
- 角色定义
- 目标说明
- 可用模板列表（前后端、数据库）
- 工作流程

```ts
export const templateGenPrompt = () => {
  return `
# 角色
你是一个代码生成器...
`;
};
```

该提示词直接影响AI生成代码的质量和格式。

**本节来源**
- [shared/prompt/template-gen.ts](file://shared\prompt\template-gen.ts#L1-L66)

### conv-repos.ts：会话存储仓库接口

新增的 `IConversationRepository` 接口抽象了会话存储层，支持多种存储实现，实现了业务逻辑与具体存储的解耦。

```ts
export interface IConversationRepository {
  // ===== 状态访问 =====
  readonly conversations: readonly Conversation[];
  readonly activeConversationId: string;
  readonly activeConversation: Conversation | undefined;
  readonly activeMessages: ChatMessage[];
  readonly conversationCount: number;

  // ===== 会话管理 =====
  createConversation(params?: CreateConversationParams): Conversation;
  updateConversation(id: string, params: UpdateConversationParams): void;
  deleteConversation(id: string): void;
  setActiveConversation(id: string): void;
  initializeDefaultConversation(): void;
  isLatestConversationEmpty(): boolean;
  switchToLatestConversation(): void;

  // ===== 消息管理 =====
  addMessage(conversationId: string, message: ChatMessage): void;
  updateMessage(
    conversationId: string,
    messageId: string,
    content: string,
    done?: boolean
  ): void;
  updateMessageReasoning(
    conversationId: string,
    messageId: string,
    reasoningContent: string,
    reasoningStatus?: ChatMessage['reasoningStatus']
  ): void;
  deleteMessage(conversationId: string, messageId: string): void;
  clearMessages(conversationId: string): void;
  getMessages(conversationId: string): ChatMessage[];

  // ===== 状态重置 =====
  reset(): void;
}
```

该接口定义了会话管理的所有操作，为 `useChat` 提供了清晰的契约。

**本节来源**
- [app/types/conv-repos.ts](file://app\types\conv-repos.ts#L1-L129) - *新增于提交 cfab565a*

### pinia-conv-repos.ts：Pinia存储适配器

`PiniaConversationRepository` 类实现了 `IConversationRepository` 接口，将原有的 `useConversationStore` 适配为统一的仓库接口。

```ts
export class PiniaConversationRepository implements IConversationRepository {
  private store: ReturnType<typeof useConversationStore>;

  constructor(store?: ReturnType<typeof useConversationStore>) {
    this.store = store || useConversationStore();
  }

  // 状态访问
  get conversations(): readonly Conversation[] {
    return this.store.conversations;
  }

  // 会话管理
  createConversation(params?: CreateConversationParams): Conversation {
    return this.store.createConversation(params);
  }

  // 消息管理
  addMessage(conversationId: string, message: ChatMessage): void {
    this.store.addMessage(conversationId, message);
  }

  // 状态重置
  reset(): void {
    this.store.reset();
  }
}
```

该适配器模式实现了依赖倒置，使 `useChat` 不再直接依赖具体的Pinia存储实现。

**本节来源**
- [app/utils/pinia-conv-repos.ts](file://app\utils\pinia-conv-repos.ts#L1-L114) - *新增于提交 cfab565a*

### useChat.ts：聊天功能组合式函数

更新后的 `useChat` 函数通过依赖注入方式接收 `IConversationRepository` 实例，实现了与具体存储实现的解耦。

```ts
export const useChat = (repository?: IConversationRepository) => {
  // 获取会话存储 - 支持依赖注入，优先使用传入的repository
  const conversationStore = repository || new PiniaConversationRepository();
  // ... 其他逻辑
};
```

关键变更：
- 接受可选的 `repository` 参数，支持外部注入不同的存储实现
- 默认使用 `PiniaConversationRepository` 作为适配器
- 通过接口调用所有会话管理操作，而非直接调用Pinia store方法

**本节来源**
- [app/composables/useChat.ts](file://app\composables\useChat.ts#L1-L377) - *重构于提交 cfab565a*

## 架构依赖关系图

``mermaid
graph LR
A[前端页面] --> B[useChat]
B --> C[IConversationRepository]
C --> D[PiniaConversationRepository]
D --> E[useConversationStore]
E --> F[Conversation Types]
A --> G[API调用]
G --> H[chat.post.ts]
H --> I[templateGenPrompt]
I --> J[shared/prompt]
H --> K[model]
K --> L[server/utils]
J --> H
F --> E
D --> C
B --> C
```

**图示来源**
- [app/composables/useChat.ts](file://app\composables\useChat.ts#L1-L377)
- [app/utils/pinia-conv-repos.ts](file://app\utils\pinia-conv-repos.ts#L1-L114)
- [app/stores/conversation.ts](file://app\stores\conversation.ts#L1-L318)
- [server/api/chat.post.ts](file://server\api\chat.post.ts#L1-L26)
- [shared/prompt/template-gen.ts](file://shared\prompt\template-gen.ts#L1-L66)

## 总结

本项目采用Nuxt 3框架，前后端分离架构，通过 `server/api` 提供接口，`app/` 组织前端逻辑，`shared/` 实现跨层复用。状态管理使用Pinia，类型系统完善，提示词模板结构清晰。

近期重构通过引入 `IConversationRepository` 接口和 `PiniaConversationRepository` 适配器，实现了 `useChat` 与会话管理的解耦。这一改进采用依赖注入和适配器模式，提高了代码的可测试性和可扩展性，为未来支持多种存储实现（如本地存储、数据库等）奠定了基础。整体架构合理，易于扩展和维护。