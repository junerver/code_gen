# 流式响应处理

<cite>
**本文档引用的文件**   
- [useChat.ts](file://app/composables/useChat.ts)
- [conversation.ts](file://app/stores/conversation.ts)
- [chat.post.ts](file://server/api/chat.post.ts)
- [chat.ts](file://app/types/chat.ts)
- [index.vue](file://app/pages/chat/index.vue)
- [id.ts](file://shared/utils/id.ts)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [流式响应前端实现](#流式响应前端实现)
4. [会话状态管理](#会话状态管理)
5. [服务器端流式响应](#服务器端流式响应)
6. [数据流与事件解析](#数据流与事件解析)
7. [错误处理机制](#错误处理机制)
8. [用户体验优化](#用户体验优化)

## 项目结构

本项目采用分层架构设计，主要分为前端（app）、后端（server）和共享（shared）三个模块。前端使用Nuxt框架，通过组合式函数（composables）管理业务逻辑，Pinia存储（stores）管理状态。后端提供API接口，利用AI SDK实现流式响应。共享模块包含跨平台工具函数。

```mermaid
graph TB
subgraph "前端 (app)"
A[composables/useChat.ts]
B[stores/conversation.ts]
C[pages/chat/index.vue]
D[types/chat.ts]
end
subgraph "后端 (server)"
E[api/chat.post.ts]
F[utils/model.ts]
end
subgraph "共享 (shared)"
G[utils/id.ts]
H[prompt/template-gen.ts]
end
A --> B
C --> A
E --> F
G --> A
H --> E
```

**图示来源**
- [useChat.ts](file://app/composables/useChat.ts)
- [conversation.ts](file://app/stores/conversation.ts)
- [chat.post.ts](file://server/api/chat.post.ts)
- [id.ts](file://shared/utils/id.ts)

**本节来源**
- [useChat.ts](file://app/composables/useChat.ts)
- [conversation.ts](file://app/stores/conversation.ts)
- [chat.post.ts](file://server/api/chat.post.ts)

## 核心组件

系统核心由三个关键组件构成：`useChat.ts` 提供聊天业务逻辑，`conversation.ts` 管理会话状态，`chat.post.ts` 处理服务器端AI响应。这些组件通过清晰的职责分离，实现了高效的流式响应机制。

**本节来源**
- [useChat.ts](file://app/composables/useChat.ts#L1-L365)
- [conversation.ts](file://app/stores/conversation.ts#L1-L318)
- [chat.post.ts](file://server/api/chat.post.ts#L1-L26)

## 流式响应前端实现

`useChat.ts` 文件中的 `generateResponse` 函数是流式响应的核心。该函数通过 `fetch` 调用 `/api/chat` 接口，获取服务器发送的SSE（Server-Sent Events）流。使用 `response.body.getReader()` 创建读取器，逐块读取响应数据。

```mermaid
sequenceDiagram
participant 前端 as 前端应用
participant useChat as useChat.ts
participant conversationStore as conversation.ts
participant 服务器 as 服务器
前端->>useChat : 发送消息
useChat->>服务器 : POST /api/chat
服务器-->>useChat : SSE流式响应
loop 逐块处理
useChat->>useChat : 读取数据块
useChat->>useChat : 解析JSON数据
useChat->>conversationStore : 更新消息内容
end
useChat-->>前端 : 响应完成
```

**图示来源**
- [useChat.ts](file://app/composables/useChat.ts#L134-L213)
- [conversation.ts](file://app/stores/conversation.ts#L128-L175)

**本节来源**
- [useChat.ts](file://app/composables/useChat.ts#L84-L213)

## 会话状态管理

`conversation.ts` 使用Pinia定义了会话状态管理。通过 `Map` 结构存储各会话的消息列表，确保高效的数据访问。`updateMessage` 函数在接收到流式数据时，实时更新指定消息的内容，并在响应完成后关闭加载状态和打字机动画。

```mermaid
classDiagram
class useConversationStore {
+conversations : Conversation[]
+activeConversationId : string
+conversationMessages : Map<string, ChatMessage[]>
+addMessage(conversationId, message)
+updateMessage(conversationId, messageId, content, done)
+updateMessageReasoning(conversationId, messageId, reasoningContent, reasoningStatus)
}
class ChatMessage {
+id : string
+content : string
+role : 'user'|'assistant'|'system'
+timestamp : Date
+typing : TypingConfig | false
+loading : boolean
+reasoningContent? : string
+reasoningStatus? : 'start'|'thinking'|'end'|'error'
}
useConversationStore --> ChatMessage : "包含"
```

**图示来源**
- [conversation.ts](file://app/stores/conversation.ts#L1-L318)
- [chat.ts](file://app/types/chat.ts#L1-L21)

**本节来源**
- [conversation.ts](file://app/stores/conversation.ts#L1-L318)
- [chat.ts](file://app/types/chat.ts#L1-L21)

## 服务器端流式响应

服务器端通过 `ai` SDK的 `streamText` 函数实现流式响应。`chat.post.ts` 文件定义了API处理器，接收客户端消息，调用Qwen大模型，并将响应转换为UI消息流。`toUIMessageStreamResponse()` 方法将AI流转换为前端可解析的SSE格式。

```mermaid
flowchart TD
Start([API请求]) --> ReadBody["读取请求体"]
ReadBody --> StreamText["调用streamText"]
StreamText --> Model["Qwen/Qwen3-Coder-30B-A3B-Instruct"]
Model --> Response["生成流式响应"]
Response --> Convert["转换为UI消息流"]
Convert --> Return["返回SSE响应"]
Return --> End([响应完成])
```

**图示来源**
- [chat.post.ts](file://server/api/chat.post.ts#L1-L26)

**本节来源**
- [chat.post.ts](file://server/api/chat.post.ts#L1-L26)

## 数据流与事件解析

前端通过解析SSE事件流实现增量渲染。服务器发送的数据格式为 `data: {json}`，前端按行分割，解析JSON数据。根据 `type` 字段区分不同类型的事件，如 `text-delta` 表示文本增量，`reasoning-delta` 表示推理过程。

```mermaid
flowchart TD
A[接收SSE流] --> B{数据行}
B --> C{以"data: "开头?}
C --> |是| D{包含"[DONE]"?}
D --> |否| E[提取JSON字符串]
E --> F[解析JSON]
F --> G{type类型}
G --> |text-delta| H[拼接文本内容]
G --> |reasoning-start| I[初始化推理内容]
G --> |reasoning-delta| J[拼接推理内容]
G --> |text-start| K[结束推理显示]
H --> L[更新消息内容]
I --> L
J --> L
K --> L
L --> M[继续读取]
C --> |否| M
D --> |是| N[流结束]
M --> O{流是否完成?}
O --> |否| A
O --> |是| P[完成响应]
```

**图示来源**
- [useChat.ts](file://app/composables/useChat.ts#L150-L170)
- [chat.ts](file://app/types/chat.ts#L1-L21)

**本节来源**
- [useChat.ts](file://app/composables/useChat.ts#L134-L213)
- [chat.ts](file://app/types/chat.ts#L1-L21)

## 错误处理机制

系统实现了多层次的错误处理。在 `generateResponse` 中，若无法获取响应流则抛出异常。在 `sendMessage` 和 `regenerate` 函数的 `try-catch` 块中捕获错误，设置错误状态，并清理异常的助手消息。对于流数据解析失败，使用 `console.warn` 记录警告而不中断主流程。

```mermaid
flowchart TD
A[发送消息] --> B[调用generateResponse]
B --> C{响应成功?}
C --> |是| D[处理流数据]
C --> |否| E[捕获错误]
E --> F[设置错误状态]
F --> G{最后消息为空?}
G --> |是| H[删除消息]
G --> |否| I[更新消息状态]
I --> J[关闭加载]
H --> J
D --> K{解析成功?}
K --> |否| L[记录警告]
K --> |是| M[更新内容]
M --> N{流完成?}
N --> |否| D
N --> |是| O[完成]
O --> J
```

**图示来源**
- [useChat.ts](file://app/composables/useChat.ts#L208-L248)
- [useChat.ts](file://app/composables/useChat.ts#L168-L213)

**本节来源**
- [useChat.ts](file://app/composables/useChat.ts#L200-L364)

## 用户体验优化

系统通过多种方式优化用户体验。首先，使用打字机动画（typing）模拟AI思考过程，通过在 `addAssistantMessage` 中设置 `typing` 配置实现。其次，实现消息ID生成机制，确保每条消息的唯一性。最后，通过防抖和滚动定位，确保新消息出现时视图自动滚动到底部。

```mermaid
flowchart TD
A[用户发送消息] --> B[添加用户消息]
B --> C[创建助手消息]
C --> D[设置typing动画]
D --> E[显示加载状态]
E --> F[流式接收AI响应]
F --> G[实时更新消息内容]
G --> H[自动滚动到底部]
H --> I{响应完成?}
I --> |否| F
I --> |是| J[关闭typing和loading]
J --> K[完成]
```

**图示来源**
- [useChat.ts](file://app/composables/useChat.ts#L40-L89)
- [conversation.ts](file://app/stores/conversation.ts#L128-L175)
- [id.ts](file://shared/utils/id.ts#L1-L28)

**本节来源**
- [useChat.ts](file://app/composables/useChat.ts#L40-L89)
- [conversation.ts](file://app/stores/conversation.ts#L128-L175)
- [id.ts](file://shared/utils/id.ts#L1-L28)