# 代码生成逻辑

<cite>
**本文档引用的文件**
- [template-gen.ts](file://server/core/prompt/template-gen.ts)
- [ai-gen.ts](file://server/core/prompt/ai-gen.ts)
- [code.ts](file://shared/utils/code.ts)
- [repair-vue.ts](file://shared/utils/repair-vue.ts)
- [template.ts](file://shared/utils/template.ts)
- [main.vue](file://app/template/main.vue)
- [element-plus.js](file://app/template/element-plus.js)
</cite>

## 目录
1. [引言](#引言)
2. [提示词构建策略](#提示词构建策略)
3. [代码块提取机制](#代码块提取机制)
4. [Vue代码修复技术](#vue代码修复技术)
5. [生成质量控制与优化](#生成质量控制与优化)
6. [实际生成案例分析](#实际生成案例分析)
7. [扩展建议与未来方向](#扩展建议与未来方向)
8. [结论](#结论)

## 引言
本文档全面阐述AI驱动的代码生成流程，从提示词构造到最终可执行代码输出的完整链路。重点分析系统提示词的构建策略、代码块提取逻辑以及对不完整或语法错误的Vue代码进行修复的技术实现。通过深入解析核心模块，揭示如何引导大语言模型生成符合Vue+Element Plus规范的高质量组件代码。

## 提示词构建策略

系统通过`template-gen.ts`和`ai-gen.ts`两个核心文件构建提示词，分别用于模板化代码生成和自由式组件生成。

### 上下文注入机制
提示词系统采用结构化上下文注入方式，确保LLM能够准确理解任务目标。在`template-gen.ts`中，通过动态生成可用模板列表，明确告知模型前端、后端及数据库脚本的可选模板类型。根据`isVue3`参数自动切换Vue2/Vue3模板选项，实现技术栈的精准匹配。

### 语法约束设计
提示词中定义了严格的Velocity模板语法处理规则，包括变量引用、条件语句、循环语句和字面输出块的处理优先级。特别强调`#[[content]]#`字面输出块的最高优先级处理，确保模板中的原始代码片段能被完整保留并正确渲染。

### 安全过滤机制
通过设定"绝对要求"级别的处理规则，防止模型自由发挥或遗漏关键步骤。例如，明确要求：
- 所有`#foreach`循环必须遍历集合中所有元素
- 缺失上下文变量时使用空字符串替代
- 禁止在输出中包含任何解释性文字

### Vue组件生成引导
`ai-gen.ts`中的提示词专门针对Vue3组件生成进行了优化，明确规定：
- 使用Vue3.5 Composition API
- 采用`<script setup>`语法糖
- 必须包含完整的JSDoc注释
- 遵循Element Plus组件库规范
- 代码块顺序为template - script - style

**本节来源**
- [template-gen.ts](file://server/core/prompt/template-gen.ts#L1-L237)
- [ai-gen.ts](file://server/core/prompt/ai-gen.ts#L1-L33)
- [template.ts](file://shared/utils/template.ts#L1-L114)

## 代码块提取机制

`shared/utils/code.ts`文件中的`extractCode`函数负责从LLM返回的文本中精确提取代码块。

### 正则匹配逻辑
使用正则表达式`\`\`\`[\s\S]*?\`\`\``匹配Markdown代码块，支持可选的语言标识符。当指定语言参数时，会生成针对性的正则模式，如`\`\`\${language}[\s\S]*?\`\`\``。

### 多代码块处理
支持通过`index`参数提取第N个代码块（从0开始计数），便于处理LLM返回多个候选方案的场景。函数返回包含源代码、行数、列数和语言标识的完整信息对象。

### 内容清洗流程
提取过程包含以下步骤：
1. 匹配完整的代码块标记
2. 提取语言标识符
3. 移除开头的\`\`\`[language]和结尾的\`\`\`
4. 去除首尾空白字符
5. 计算代码行数和最大列数

该机制确保了即使LLM在代码块前后添加了解释性文字，也能准确提取出纯净的可执行代码。

**本节来源**
- [code.ts](file://shared/utils/code.ts#L1-L227)

## Vue代码修复技术

`repair-vue.ts`模块实现了对不完整或语法错误的Vue代码的智能修复能力。

### 组件结构提取
`extractVuePart`函数通过精确的标签匹配算法提取Vue组件的三个核心部分：
- `<template>` 模板部分
- `<script setup>` 脚本部分
- `<style scoped>` 样式部分

采用深度优先的标签匹配策略，正确处理嵌套标签情况，避免因标签嵌套导致的提取错误。

### Vue API依赖分析
系统内置常用Vue API列表（如`ref`、`reactive`、`computed`等），通过正则匹配检测代码中实际使用的API。

### 智能导入修复
修复流程包含以下关键步骤：
1. 检测代码中使用的Vue API
2. 分析脚本中已存在的Vue导入
3. 计算缺失的API
4. 生成完整的导入语句
5. 合并现有导入与缺失API

当发现已有`import { ... } from 'vue'`语句时，会先移除原语句，再生成包含所有必要API的完整导入语句，避免重复导入。

### 预览代码生成
`genPreviewCode`函数将提取和修复后的各部分重新组合，生成可直接预览的完整Vue组件代码，确保结构规范、导入完整。

**本节来源**
- [repair-vue.ts](file://shared/utils/repair-vue.ts#L1-L239)
- [code.ts](file://shared/utils/code.ts#L1-L227)

## 生成质量控制与优化

系统实施多层次的质量控制措施，确保生成代码的可用性和规范性。

### 格式化与标准化
通过`trimIndent`工具函数去除代码首尾的多余缩进，保持代码格式整洁。所有生成的代码都遵循统一的结构顺序：template → script → style。

### 标签闭合检测
在代码提取和修复过程中，通过精确的标签匹配算法确保所有HTML标签正确闭合，防止因标签未闭合导致的渲染错误。

### 版本依赖管理
`buildElementPlusSetup`函数动态生成Element Plus的样式加载代码，支持指定版本号，确保UI组件库版本一致性。

### 导入映射生成
`generateImportMap`函数为现代浏览器环境生成完整的模块导入映射，包含Vue、Element Plus及其图标库的CDN地址，支持快速预览。

### 类型支持配置
`buildTsconfig`函数生成标准化的tsconfig.json配置，启用Vue编译器选项和必要的类型支持。

**本节来源**
- [code.ts](file://shared/utils/code.ts#L1-L227)
- [repair-vue.ts](file://shared/utils/repair-vue.ts#L1-L239)

## 实际生成案例分析

### 原始输出问题
LLM可能生成以下不完整代码：
```vue
<script setup>
const count = ref(0)
</script>

<template>
  <el-button @click="count++">{{ count }}</el-button>
</template>
```

### 修复后结果
系统自动修复为：
```vue
<script setup>
import { ref } from 'vue'
const count = ref(0)
</script>

<template>
  <el-button @click="count++">{{ count }}</el-button>
</template>

<style scoped>
</style>
```

### 关键处理步骤
1. 检测到使用`ref`但未导入
2. 识别`<script setup>`语法
3. 生成`import { ref } from 'vue'`语句
4. 保持原有逻辑不变
5. 补充空的`<style scoped>`标签

此案例展示了系统如何将不完整的原型代码转化为符合规范的生产就绪代码。

**本节来源**
- [repair-vue.ts](file://shared/utils/repair-vue.ts#L1-L239)
- [code.ts](file://shared/utils/code.ts#L1-L227)

## 扩展建议与未来方向

### 多框架支持
当前系统主要支持Vue+Element Plus，可扩展支持：
- React + Ant Design
- Angular + Material
- Svelte + Tailwind CSS

### 更多模板类型
可增加更多前端模板类型：
- **vue_v3_table**: Vue3表格组件模板
- **vue_v3_dialog**: Vue3对话框组件模板
- **vue_v3_form_advanced**: 高级表单组件模板

### 智能错误预测
基于历史修复数据训练模型，预测常见错误模式，在生成阶段就避免典型问题。

### 可视化配置
提供图形化界面配置提示词模板，降低非技术人员的使用门槛。

### 性能优化建议
在生成代码时自动添加性能优化建议，如：
- 大列表的虚拟滚动
- 图片懒加载
- 组件懒加载

**本节来源**
- [template-gen.ts](file://server/core/prompt/template-gen.ts#L1-L237)
- [template.ts](file://shared/utils/template.ts#L1-L114)

## 结论
本文档详细解析了AI驱动的代码生成系统的完整链路。通过精心设计的提示词系统、精确的代码提取机制和智能的代码修复技术，实现了从自然语言需求到高质量可执行代码的自动化转换。系统不仅能够生成符合Vue+Element Plus规范的组件代码，还能自动修复常见的语法错误和依赖缺失问题，显著提升了开发效率。未来可通过扩展框架支持和增强智能预测能力，进一步提升系统的适用性和智能化水平。