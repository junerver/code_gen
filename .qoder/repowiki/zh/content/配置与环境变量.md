# 配置与环境变量

<cite>
**本文档引用文件**  
- [nuxt.config.ts](file://nuxt.config.ts)
- [model.ts](file://server/utils/model.ts)
- [.env.example](file://.env.example)
- [chat.post.ts](file://server/api/chat.post.ts)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构概览](#项目结构概览)
3. [核心配置体系](#核心配置体系)
4. [运行时配置详解](#运行时配置详解)
5. [模型配置与默认值机制](#模型配置与默认值机制)
6. [环境变量管理](#环境变量管理)
7. [配置项清单](#配置项清单)
8. [开发与生产配置示例](#开发与生产配置示例)
9. [安全性最佳实践](#安全性最佳实践)
10. [结论](#结论)

## 简介
本文档系统化整理 `code_gen` 项目的配置体系与环境变量管理方案，重点解析 Nuxt 框架中 `runtimeConfig` 的使用方式，说明公共与私有运行时配置的区别，阐述如何通过 `.env` 文件安全地注入敏感信息（如 API 密钥），并描述模型配置的默认值与可覆盖机制。目标是帮助开发者正确部署和个性化定制应用，避免密钥泄露等安全风险。

## 项目结构概览
项目采用典型的 Nuxt 3 架构，主要分为 `app`（前端界面）、`server`（服务端逻辑）、`shared`（共享类型与工具）三大模块。配置相关的核心文件包括：
- `nuxt.config.ts`：Nuxt 主配置文件，定义运行时配置
- `.env.example`：环境变量模板
- `server/utils/model.ts`：模型提供器与语言模型创建逻辑
- `server/api/chat.post.ts`：聊天接口，使用运行时配置初始化模型

## 核心配置体系
本项目基于 Nuxt 3 的 `runtimeConfig` 实现统一的配置管理，区分公共与私有配置，确保敏感信息不会暴露至客户端。

**Section sources**
- [nuxt.config.ts](file://nuxt.config.ts#L12-L20)

## 运行时配置详解
在 `nuxt.config.ts` 中通过 `runtimeConfig` 定义了多个运行时配置项，这些配置在服务端可用，并可通过环境变量动态注入：

```ts
runtimeConfig: {
  siliconFlowApiUrl: '',
  siliconFlowApiKey: '',
  deepseekApiKey: '',
  bailianApiUrl: '',
  bailianApiKey: '',
  mcpServerDirectory: '',
}
```

### 公共与私有配置区别
Nuxt 的 `runtimeConfig` 支持自动区分公共与私有配置：
- **私有配置**：仅在服务端可用，不会暴露给前端。所有在 `runtimeConfig` 中定义的字段默认为私有。
- **公共配置**：需显式挂载到 `runtimeConfig.public` 下，才能在客户端访问。

> 本项目未使用 `public` 子对象，所有配置均为私有，确保 API 密钥等敏感信息不会泄露。

**Section sources**
- [nuxt.config.ts](file://nuxt.config.ts#L12-L20)

## 模型配置与默认值机制
`server/utils/model.ts` 是模型配置的核心文件，负责根据运行时配置动态创建语言模型实例。

### 模型创建流程
1. 从 `useRuntimeConfig()` 获取 API 地址与密钥
2. 使用 `@ai-sdk/openai-compatible` 等 SDK 创建兼容的模型客户端
3. 根据模型配置（`AvailableModels`）动态生成模型实例
4. 支持中间件（如 `think` 推理提取）

### 默认值与可覆盖机制
- 所有配置项在 `nuxt.config.ts` 中初始化为空字符串或默认值
- 实际值通过环境变量（`.env` 文件）注入，实现不同环境的差异化配置
- 模型温度（temperature）等参数在 API 调用时可由客户端传入，默认为 0

**Section sources**
- [model.ts](file://server/utils/model.ts#L25-L121)
- [chat.post.ts](file://server/api/chat.post.ts#L25-L35)

## 环境变量管理
项目通过 `.env` 文件管理环境变量，遵循 Nuxt 的命名规范：以 `NUXT_` 开头。

### 支持的环境变量
| 环境变量名 | 用途 | 是否敏感 |
|-----------|------|---------|
| `NUXT_SILICON_FLOW_API_URL` | 硅基流动 API 地址 | 否 |
| `NUXT_SILICON_FLOW_API_KEY` | 硅基流动 API 密钥 | 是 |
| `NUXT_DEEPSEEK_API_KEY` | DeepSeek API 密钥 | 是 |
| `NUXT_BAILIAN_API_URL` | 阿里百炼 API 地址 | 否 |
| `NUXT_BAILIAN_API_KEY` | 阿里百炼 API 密钥 | 是 |
| `NUXT_MCP_SERVER_DIRECTORY` | MCP 服务目录路径 | 否 |

### 加载机制
Nuxt 自动将 `NUXT_` 前缀的环境变量注入到 `runtimeConfig` 中，无需手动读取。

**Section sources**
- [.env.example](file://.env.example#L1-L9)
- [nuxt.config.ts](file://nuxt.config.ts#L12-L20)

## 配置项清单
| 配置项 | 类型 | 默认值 | 说明 |
|-------|------|--------|------|
| `siliconFlowApiUrl` | string | "" | 硅基流动 API 基地址 |
| `siliconFlowApiKey` | string | "" | 硅基流动 API 密钥（私有） |
| `deepseekApiKey` | string | "" | DeepSeek API 密钥（私有） |
| `bailianApiUrl` | string | "" | 阿里百炼 API 基地址 |
| `bailianApiKey` | string | "" | 阿里百炼 API 密钥（私有） |
| `mcpServerDirectory` | string | "" | MCP 服务项目路径 |
| `temperature` | number | 0 | 模型生成温度（API 参数） |
| `maxTokens` | number | 无显式设置 | 最大生成 token 数（由模型决定） |

> 注：`temperature` 在 `chat.post.ts` 中作为可选参数传入，默认为 0。

**Section sources**
- [nuxt.config.ts](file://nuxt.config.ts#L12-L20)
- [model.ts](file://server/utils/model.ts#L25-L121)
- [chat.post.ts](file://server/api/chat.post.ts#L25-L35)

## 开发与生产配置示例
### 本地开发配置（.env.local）
```env
NUXT_SILICON_FLOW_API_URL=https://api.siliconflow.cn/v1
NUXT_SILICON_FLOW_API_KEY=sk-xxxxxx
NUXT_DEEPSEEK_API_KEY=sk-xxxxxx
NUXT_BAILIAN_API_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
NUXT_BAILIAN_API_KEY=sk-xxxxxx
NUXT_MCP_SERVER_DIRECTORY=./test_mcp_server
```

### 生产部署配置（CI/CD 环境变量）
```env
NUXT_SILICON_FLOW_API_KEY=${PROD_SILICONFLOW_KEY}
NUXT_DEEPSEEK_API_KEY=${PROD_DEEPSEEK_KEY}
NUXT_BAILIAN_API_KEY=${PROD_BAILIAN_KEY}
NUXT_MCP_SERVER_DIRECTORY=/var/mcp/servers
```

> 生产环境建议通过 CI/CD 系统注入密钥，避免将 `.env` 文件提交至代码仓库。

**Section sources**
- [.env.example](file://.env.example#L1-L9)

## 安全性最佳实践
1. **绝不提交敏感信息**：`.env` 文件应加入 `.gitignore`，仅保留 `.env.example` 作为模板。
2. **使用私有配置**：确保 API 密钥等敏感信息仅在 `runtimeConfig` 中定义，不挂载到 `public`。
3. **最小权限原则**：API 密钥应使用最小必要权限，避免使用主账号密钥。
4. **定期轮换密钥**：定期更新 API 密钥，降低泄露风险。
5. **CI/CD 安全注入**：生产环境通过安全的环境变量注入机制（如 GitHub Secrets）提供密钥。
6. **避免日志输出**：确保运行时配置不会被意外打印到日志中。

**Section sources**
- [nuxt.config.ts](file://nuxt.config.ts#L12-L20)
- [.env.example](file://.env.example#L1-L9)

## 结论
`code_gen` 项目通过 Nuxt 的 `runtimeConfig` 实现了安全、灵活的配置管理体系。敏感信息通过环境变量在服务端注入，确保不会暴露至客户端。模型配置支持动态扩展与默认值覆盖，便于集成多种 AI 服务。开发者应遵循安全性最佳实践，合理配置环境变量，确保应用在开发与生产环境中的安全与稳定运行。